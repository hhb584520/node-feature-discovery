<!DOCTYPE html> <html lang="en" dir="auto"> <head><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> <meta name="description" content="Deployment and Usage Table of Contents System requirements Usage NFD-Master NFD-Worker NFD-Master and NFD-Worker in the same Pod TLS authentication..."> <meta name="revised" content=""> <meta name="author" content="Kubernetes SIGs"> <meta name="generator" content="jekyll-rtd-theme v2.0.9"> <meta property="og:title" content="Deployment and Usage · Node Feature Discovery"> <meta property="og:description" content="Deployment and Usage Table of Contents System requirements Usage NFD-Master NFD-Worker NFD-Master and NFD-Worker in the same Pod TLS authentication..."> <meta property="og:locale" content="en"> <meta property="og:url" content="https://kubernetes-sigs.github.com/node-feature-discovery/v0.6/get-started/deployment-and-usage.html"> <meta property="og:type" content="article"> <meta property="article:author" content="Kubernetes SIGs"> <meta property="article:published_time" content="2016-07-23T00:07:52-05:00"> <meta property="article:modified_time" content="2020-11-02T03:21:37-06:00"> <meta name="twitter:title" content="Deployment and Usage · Node Feature Discovery"> <meta name="twitter:description" content="Deployment and Usage Table of Contents System requirements Usage NFD-Master NFD-Worker NFD-Master and NFD-Worker in the same Pod TLS authentication..."> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@Kubernetes SIGs"> <meta name="twitter:url" content="https://kubernetes-sigs.github.com/node-feature-discovery/v0.6/get-started/deployment-and-usage.html"> <meta name="twitter:creator" content="@jekyll-rtd-theme v2.0.9"> <title>Deployment and Usage · Node Feature Discovery</title> <link rel="dns-prefetch" href="https://rundocs-analytics.glitch.me"> <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"> <link rel="canonical" href="https://kubernetes-sigs.github.com/node-feature-discovery/v0.6/get-started/deployment-and-usage.html"><link rel="prev" href="https://kubernetes-sigs.github.com/node-feature-discovery/v0.6/get-started/quick-start.html"><link rel="next" href="https://kubernetes-sigs.github.com/node-feature-discovery/v0.6/get-started/features.html"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.9/assets/css/theme.min.css"> <link rel="icon" type="image/svg+xml" href="/node-feature-discovery/v0.6/assets/images/favicon.svg"> <link rel="icon" type="image/png" href="/node-feature-discovery/v0.6/assets/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/node-feature-discovery/v0.6/assets/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/node-feature-discovery/v0.6/assets/images/favicon-96x96.png" sizes="96x96"> <link rel="mask-icon" href="/node-feature-discovery/v0.6/assets/images/favicon.svg" color="#2980b9"> <link rel="apple-touch-icon" href="/node-feature-discovery/v0.6/assets/images/apple-touch-icon-300x300.jpg"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": "https://kubernetes-sigs.github.com/node-feature-discovery/v0.6/get-started/deployment-and-usage.html" }, "headline": "Deployment and Usage · Node Feature Discovery", "image": [], "author": { "@type": "Person", "name": "Kubernetes SIGs" }, "datePublished": "2016-07-23T00:07:52-05:00", "dateModified": "2020-11-02T03:21:37-06:00", "publisher": { "@type": "Organization", "name": "Kubernetes SIGs", "logo": { "@type": "ImageObject", "url": "https://avatars1.githubusercontent.com/u/36015203?v=4" } }, "description": "Deployment and Usage Table of Contents System requirements Usage NFD-Master NFD-Worker NFD-Master and NFD-Worker in the same Pod TLS authentication..." } </script> </head> <body class="container"><div class="sidebar-wrap overflow-hidden"> <div class="sidebar height-full overflow-y-scroll overflow-x-hidden"> <div class="header d-flex flex-column p-3 text-center"> <div class="title pb-1"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/node-feature-discovery/v0.6/" title="Documentation of Node Feature Discovery - a Kubernetes add-on for discovering and advertising hardware features and system configuration in the cluster."> <i class="fa fa-home"></i> Node Feature Discovery </a> </div> <span class="version">v0.6</span> <form class="search pt-2" action="/node-feature-discovery/v0.6/search.html" method="get" autocomplete="off"> <input class="form-control input-block input-sm" type="text" name="q" placeholder="Search docs..."> </form> </div> <div class="toctree py-2" data-spy="affix" role="navigation" aria-label="main navigation"> <ul> </ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/node-feature-discovery/v0.6/get-started/"> Get started </a><ul> <li class="toc level-1 " data-sort="1" data-level="1"> <a class="d-flex flex-items-baseline " href="/node-feature-discovery/v0.6/get-started/introduction.html">1. Introduction</a> </li> <li class="toc level-1 " data-sort="2" data-level="1"> <a class="d-flex flex-items-baseline " href="/node-feature-discovery/v0.6/get-started/quick-start.html">2. Quick Start</a> </li> <li class="toc level-1 current" data-sort="3" data-level="1"> <a class="d-flex flex-items-baseline current" href="/node-feature-discovery/v0.6/get-started/deployment-and-usage.html">3. Deployment and Usage</a> </li> <li class="toc level-1 " data-sort="4" data-level="1"> <a class="d-flex flex-items-baseline " href="/node-feature-discovery/v0.6/get-started/features.html">4. Feature Discovery</a> </li> <li class="toc level-1 " data-sort="5" data-level="1"> <a class="d-flex flex-items-baseline " href="/node-feature-discovery/v0.6/get-started/examples-and-demos.html">5. Examples and Demos</a> </li></ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/node-feature-discovery/v0.6/advanced/"> Developer Guide </a><ul> </ul> <a class="caption d-block text-uppercase no-wrap px-2 py-0" href="/node-feature-discovery/v0.6/contributing/"> Contributing </a><ul> </ul> </div> </div> </div> <div class="content-wrap"> <div class="header d-flex flex-justify-between p-2 hide-lg hide-xl" aria-label="top navigation"> <button id="toggle" class="btn-octicon p-2 m-0 text-white" type="button"> <i class="fa fa-bars"></i> </button> <div class="title flex-1 d-flex flex-justify-center"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/node-feature-discovery/v0.6/">Node Feature Discovery</a> </div> </div> <div class="content p-3 p-sm-5"> <div class="navigation-top d-flex flex-justify-between"> <ul class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation"> <li class="breadcrumb-item"> <a class="no-underline" href="/node-feature-discovery/v0.6/" title="/"> <i class="fa fa-home"></i> </a> </li><li class="breadcrumb-item" ><a href="/node-feature-discovery/v0.6/get-started/">get-started</a></li><li class="breadcrumb-item" aria-current="page">deployment-and-usage.md</li></ul> <a class="edit" href="https://github.com/kubernetes-sigs/node-feature-discovery/edit/gh-pages/get-started/deployment-and-usage.md" title="Edit on GitHub" rel="noreferrer" target="_blank"> <i class="fa fa-edit"></i> </a> </div> <hr> <div role="main" itemscope="itemscope" itemtype="http://schema.org/Article"> <div class="markdown-body" itemprop="articleBody"> <h1 class="no_toc" id="deployment-and-usage">Deployment and Usage</h1> <h2 class="no_toc text-delta" id="table-of-contents">Table of Contents</h2> <ol id="markdown-toc"> <li><a href="#system-requirements" id="markdown-toc-system-requirements">System requirements</a></li> <li><a href="#usage" id="markdown-toc-usage">Usage</a> <ol> <li><a href="#nfd-master" id="markdown-toc-nfd-master">NFD-Master</a></li> <li><a href="#nfd-worker" id="markdown-toc-nfd-worker">NFD-Worker</a></li> <li><a href="#nfd-master-and-nfd-worker-in-the-same-pod" id="markdown-toc-nfd-master-and-nfd-worker-in-the-same-pod">NFD-Master and NFD-Worker in the same Pod</a></li> <li><a href="#tls-authentication" id="markdown-toc-tls-authentication">TLS authentication</a></li> </ol> </li> <li><a href="#deployment-options" id="markdown-toc-deployment-options">Deployment options</a> <ol> <li><a href="#deployment-templates" id="markdown-toc-deployment-templates">Deployment Templates</a></li> <li><a href="#build-your-own" id="markdown-toc-build-your-own">Build Your Own</a></li> </ol> </li> <li><a href="#configuration" id="markdown-toc-configuration">Configuration</a></li> <li><a href="#using-node-labels" id="markdown-toc-using-node-labels">Using Node Labels</a></li> </ol> <hr /> <h3 id="system-requirements">System requirements</h3> <ol> <li>Linux (x86_64/Arm64/Arm)</li> <li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl">kubectl</a> (properly set up and configured to work with your Kubernetes cluster)</li> <li><a href="https://docs.docker.com/install">Docker</a> (only required to build and push docker images)</li> </ol> <h2 id="usage">Usage</h2> <h3 id="nfd-master">NFD-Master</h3> <p>NFD-Master runs as a deployment (with a replica count of 1), by default it prefers running on the cluster's master nodes but will run on worker nodes if no master nodes are found.</p> <p>For High Availability, you should simply increase the replica count of the deployment object. You should also look into adding <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity">inter-pod</a> affinity to prevent masters from running on the same node. However note that inter-pod affinity is costly and is not recommended in bigger clusters.</p> <p>You can use the template spec provided to deploy nfd-master, or use <code class="language-plaintext highlighter-rouge notranslate">nfd-master.yaml</code> generated by <code class="language-plaintext highlighter-rouge notranslate">Makefile</code>. The latter includes <code class="language-plaintext highlighter-rouge notranslate">image:</code> and <code class="language-plaintext highlighter-rouge notranslate">namespace:</code> definitions that match the latest built image. Example:</p> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>make <span class="nv">IMAGE_TAG</span><span class="o">=</span>&lt;IMAGE_TAG&gt;
docker push &lt;IMAGE_TAG&gt;
kubectl create <span class="nt">-f</span> nfd-master.yaml
</code></pre>  </div></div> <p>NFD-Master listens for connections from nfd-worker(s) and connects to the Kubernetes API server to add node labels advertised by them.</p> <p>If you have RBAC authorization enabled (as is the default e.g. with clusters initialized with kubeadm) you need to configure the appropriate ClusterRoles, ClusterRoleBindings and a ServiceAccount in order for NFD to create node labels. The provided template will configure these for you.</p> <h3 id="nfd-worker">NFD-Worker</h3> <p>NFD-Worker is preferably run as a Kubernetes DaemonSet. There is an example spec (<code class="language-plaintext highlighter-rouge notranslate">nfd-worker-daemonset.yaml.template</code>) that can be used as a template, or, as is when just trying out the service. Similarly to nfd-master above, the <code class="language-plaintext highlighter-rouge notranslate">Makefile</code> also generates <code class="language-plaintext highlighter-rouge notranslate">nfd-worker-daemonset.yaml</code> from the template that you can use to deploy the latest image. Example:</p> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>make <span class="nv">IMAGE_TAG</span><span class="o">=</span>&lt;IMAGE_TAG&gt;
docker push &lt;IMAGE_TAG&gt;
kubectl create <span class="nt">-f</span> nfd-worker-daemonset.yaml
</code></pre>  </div></div> <p>NFD-Worker connects to the nfd-master service to advertise hardware features.</p> <p>When run as a daemonset, nodes are re-labeled at an interval specified using the <code class="language-plaintext highlighter-rouge notranslate">--sleep-interval</code> option. In the <a href="https://github.com/kubernetes-sigs/node-feature-discovery/blob/master/nfd-worker-daemonset.yaml.template#L26">template</a> the default interval is set to 60s which is also the default when no <code class="language-plaintext highlighter-rouge notranslate">--sleep-interval</code> is specified. Also, the configuration file is re-read on each iteration providing a simple mechanism of run-time reconfiguration.</p> <p>Feature discovery can alternatively be configured as a one-shot job. There is an example script in this repo that demonstrates how to deploy the job in the cluster.</p> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>./label-nodes.sh <span class="o">[</span>&lt;IMAGE_TAG&gt;]
</code></pre>  </div></div> <p>The label-nodes.sh script tries to launch as many jobs as there are Ready nodes. Note that this approach does not guarantee running once on every node. For example, if some node is tainted NoSchedule or fails to start a job for some other reason, then some other node will run extra job instance(s) to satisfy the request and the tainted/failed node does not get labeled.</p> <h3 id="nfd-master-and-nfd-worker-in-the-same-pod">NFD-Master and NFD-Worker in the same Pod</h3> <p>You can also run nfd-master and nfd-worker inside a single pod (skip the <code class="language-plaintext highlighter-rouge notranslate">sed</code> part if running the latest released version):</p> <div class="language-bash highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="nb">sed</span> <span class="nt">-E</span> s<span class="s1">',^(\s*)image:.+$,\1image: &lt;YOUR_IMAGE_REPO&gt;:&lt;YOUR_IMAGE_TAG&gt;,'</span> nfd-daemonset-combined.yaml.template <span class="o">&gt;</span> nfd-daemonset-combined.yaml
kubectl apply <span class="nt">-f</span> nfd-daemonset-combined.yaml
</code></pre>  </div></div> <p>Similar to the nfd-worker setup above, this creates a DaemonSet that schedules an NFD Pod an all worker nodes, with the difference that the Pod also also contains an nfd-master instance. In this case no nfd-master service is run on the master node(s), but, the worker nodes are able to label themselves.</p> <p>This may be desirable e.g. in single-node setups.</p> <h3 id="tls-authentication">TLS authentication</h3> <p>NFD supports mutual TLS authentication between the nfd-master and nfd-worker instances. That is, nfd-worker and nfd-master both verify that the other end presents a valid certificate.</p> <p>TLS authentication is enabled by specifying <code class="language-plaintext highlighter-rouge notranslate">--ca-file</code>, <code class="language-plaintext highlighter-rouge notranslate">--key-file</code> and <code class="language-plaintext highlighter-rouge notranslate">--cert-file</code> args, on both the nfd-master and nfd-worker instances. The template specs provided with NFD contain (commented out) example configuration for enabling TLS authentication.</p> <p>The Common Name (CN) of the nfd-master certificate must match the DNS name of the nfd-master Service of the cluster. By default, nfd-master only check that the nfd-worker has been signed by the specified root certificate (–ca-file). Additional hardening can be enabled by specifying –verify-node-name in nfd-master args, in which case nfd-master verifies that the NodeName presented by nfd-worker matches the Common Name (CN) of its certificate. This means that each nfd-worker requires a individual node-specific TLS certificate.</p> <h2 id="deployment-options">Deployment options</h2> <h3 id="deployment-templates">Deployment Templates</h3> <p>For a stable version with ready-built images see the <a href="https://github.com/kubernetes-sigs/node-feature-discovery/tree/v0.6.0">latest released version</a> (<a href="https://github.com/kubernetes-sigs/node-feature-discovery/releases/latest">release notes</a>).</p> <h3 id="build-your-own">Build Your Own</h3> <p>If you want to use the latest development version (master branch) you need to build your own custom image. See the <a href="advanced-developer-guide.md">Developer Guide</a> for instructions how to build images and deploy them on your cluster.</p> <h2 id="configuration">Configuration</h2> <p>NFD-Worker supports a configuration file. The default location is <code class="language-plaintext highlighter-rouge notranslate">/etc/kubernetes/node-feature-discovery/nfd-worker.conf</code>, but, this can be changed by specifying the<code class="language-plaintext highlighter-rouge notranslate">--config</code> command line flag. Configuration file is re-read on each labeling pass (determined by <code class="language-plaintext highlighter-rouge notranslate">--sleep-interval</code>) which makes run-time re-configuration of nfd-worker possible.</p> <p>Worker configuration file is read inside the container, and thus, Volumes and VolumeMounts are needed to make your configuration available for NFD. The preferred method is to use a ConfigMap which provides easy deployment and re-configurability. For example, create a config map using the example config as a template:</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>cp nfd-worker.conf.example nfd-worker.conf
vim nfd-worker.conf  # edit the configuration
kubectl create configmap nfd-worker-config --from-file=nfd-worker.conf
</code></pre>  </div></div> <p>Then, configure Volumes and VolumeMounts in the Pod spec (just the relevant snippets shown below):</p> <div class="language-yaml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
  <span class="na">containers</span><span class="pi">:</span>
      <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nfd-worker-config</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/etc/kubernetes/node-feature-discovery/"</span>
<span class="nn">...</span>
  <span class="na">volumes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">nfd-worker-config</span>
      <span class="na">configMap</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">nfd-worker-config</span>
<span class="nn">...</span>
</code></pre>  </div></div> <p>You could also use other types of volumes, of course. That is, hostPath if different config for different nodes would be required, for example.</p> <p>The (empty-by-default) <a href="https://github.com/kubernetes-sigs/node-feature-discovery/blob/master/nfd-worker.conf.example">example config</a> is used as a config in the NFD Docker image. Thus, this can be used as a default configuration in custom-built images.</p> <p>Configuration options can also be specified via the <code class="language-plaintext highlighter-rouge notranslate">--options</code> command line flag, in which case no mounts need to be used. The same format as in the config file must be used, i.e. JSON (or YAML). For example:</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>--options='{"sources": { "pci": { "deviceClassWhitelist": ["12"] } } }'
</code></pre>  </div></div> <p>Configuration options specified from the command line will override those read from the config file.</p> <p>Currently, the only available configuration options are related to the <a href="#cpu-features">CPU</a>, <a href="#pci-features">PCI</a> and <a href="#kernel-features">Kernel</a> feature sources.</p> <h2 id="using-node-labels">Using Node Labels</h2> <p>Nodes with specific features can be targeted using the <code class="language-plaintext highlighter-rouge notranslate">nodeSelector</code> field. The following example shows how to target nodes with Intel TurboBoost enabled.</p> <div class="language-yaml highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">env</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">golang-test</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">image</span><span class="pi">:</span> <span class="s">golang</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">go1</span>
  <span class="na">nodeSelector</span><span class="pi">:</span>
    <span class="s">feature.node.kubernetes.io/cpu-pstate.turbo</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
</code></pre>  </div></div> <p>For more details on targeting nodes, see [node selection][node-sel].</p> <!-- Links --> </div> </div> <div class="navigation-bottom d-flex flex-justify-between py-3" role="navigation" aria-label="footer navigation"> <div class="prev"><a href="/node-feature-discovery/v0.6/get-started/quick-start.html" class="btn" title="Quick Start" accesskey="p" rel="prev"> <i class="fa fa-arrow-circle-left"></i> Previous </a></div> <div class="next"><a href="/node-feature-discovery/v0.6/get-started/features.html" class="btn" title="Feature Discovery" accesskey="n" rel="next"> Next <i class="fa fa-arrow-circle-right"></i> </a></div> </div><hr> <div class="copyright text-center text-gray" role="contentinfo"> <i class="fa fa-copyright"></i> <span class="time">2016-2020,</span> <a class="text-gray" href="https://github.com/kubernetes-sigs" rel="noreferrer" target="_blank">Kubernetes SIGs</a> Revision <a class="text-gray" href="https://github.com/kubernetes-sigs/node-feature-discovery/commit/" title="" rel="noreferrer" target="_blank"></a> <br> <div class="generator"> Built with <a href="https://jekyllrb.com" rel="noreferrer" target="_blank">Jekyll</a> using a <a href="https://github.com/rundocs/jekyll-rtd-theme" rel="noreferrer" target="_blank" title="remote theme: jekyll-rtd-theme v2.0.9">theme</a> provided by <a href="https://rundocs.io" rel="noreferrer" target="_blank">RunDocs</a>. </div> </div> </div> </div> <div class="addons-wrap d-flex flex-column overflow-y-auto"> <div class="status d-flex flex-justify-between p-2"> <div class="title p-1"> <i class="fa fa-book"></i> Node Feature Discovery </div> <div class="branch p-1"> <span class="name"> v0.6 </span> <i class="fa fa-caret-down"></i> </div> </div> <div class="addons d-flex flex-column height-full p-2 d-none"> <dl id="versions"> <dt>Versions</dt> <script src="/node-feature-discovery/versions.js"></script> <script> var dt = document.getElementById('versions'); var items = getVersionListItems(); for (var i=0; i < items.length; i++) { var dd = document.createElement('dd'); var a = dd.appendChild(document.createElement('a')); a.appendChild(document.createTextNode(items[i].name)); a.href = items[i].url; dt.appendChild(dd); } </script> </dl> <dl> <dt>GitHub</dt> <dd> <a href="https://github.com/kubernetes-sigs/node-feature-discovery" title="Stars: 227"> <i class="fa fa-github"></i> Homepage </a> </dd> <dd> <a href="https://github.com/kubernetes-sigs/node-feature-discovery/issues" title="Open issues: 15"> <i class="fa fa-question-circle-o"></i> Issues </a> </dd> <dd> <a href="https://github.com/kubernetes-sigs/node-feature-discovery/zipball/gh-pages" title="Size: 78178 Kb"> <i class="fa fa-download"></i> Download </a> </dd> </dl> <hr> <div class="license f6 pb-2"> The <a href="/node-feature-discovery/v0.6/">software</a> is under the terms of <a href="https://github.com/kubernetes-sigs/node-feature-discovery">Apache License 2.0</a>. </div> </div> </div> <script> window.ui = { title: "Node Feature Discovery", baseurl: "/node-feature-discovery/v0.6", i18n: { search_results: "Search Results", search_results_found: "Search finished, found # page(s) matching the search query.", search_results_not_found: "Your search did not match any documents, please make sure that all characters are spelled correctly!" } }; </script> <script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.9/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.9/assets/js/theme.min.js"></script> </body> </html>